设计经验

目录

## 1、task_record, task_detail, sub_detail

![draw.io]()

举例：

1. 批量取消：记录3表 + mq。
   1. 3表作用
      1. 拆分大动作；
      2. 记录成功/失败数量、请求&响应数据、其他等信息。
   2. mq作用：解耦、削峰、异步，此外还能自动出错重试。
2. 导出escel：1表 + 定时任务
   1. 1表：记录信息、失败重试时有完整信息；
   2. 定时任务：比如发版时程序重启导致失败，用定时任务定期扫描 task_record 表可进行自动恢复。

## 2、DB + ES 双写

ES：解决分库分表分页查询问题；同时也可以在做统计时加速响应。

如何做到的同步？

延迟如何处理的？

分别适用什么场景？分页查询肯定是只能用es，此外统计用 es 性能也更好，其他情况可以走 db，因为准确且延迟低。

## 3、异步操作遇到服务重启

异步可用 MQ，这样即使服务重启，MQ 消费失败会自动重新消费，如：折扣中批量取消、批量更新；

也可用定时任务拉起，如：折扣中异步导出sku列表，用crane定时任务拉起；

## 4、binlog 驱动 es 和 mq

[DTS-数据传输服务](https://km.sankuai.com/collabpage/748004373)可直接根据 binlog （可添加过滤条件，如仅监听 name 列发生变化时发 mq）发消息到 mq，再进行消费处理。

## 5、配置详细每条 sql 打印日志

包含 sql 语句、参数、结果行数，例如：

点击展开内容

![Screenshot 2025-08-20 at 10.20.10.png](https://km.sankuai.com/api/file/cdn/2713456939/186338397979?contentType=1&isNewContent=false)