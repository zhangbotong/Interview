## HR面

### 离职原因

1. 为了寻求更好的职业发展、专业成长（这家公司的发展与个人的职业规划相悖，无法得到更大的发展空间），去互联网大厂发展发展。寻求一个更大的平台能更好的调动工作的热情。这期间做了一些准备工作，美团的业务发展和技术更适合我（用java，pass掉字节，技术上更加务实不会上来不计成本的打价格战，比较理性，这样的公司能够长久的可持续发展。）
2. 追求更高的薪资。工资不太高，且从去年开始财务状况不太好开始拖欠工资、年终奖。leader人不错也比较认可我，跟他有什么说什么，大幅涨薪可能不大。
3. 个人正打算边工作边看新的机会，想去大厂。然后今年公司被央企收购了，这家央企的规定是所有员工的合同薪资只写3k，但实际发放正常发放，所以集团要求公司层面去做大家的工作，劝说大家修改原合同。有些人签了，有些没签。因为本来我就在看机会所以先没签，又恰赶上上一份合同到期，两个选择：一是选择续签新合同继续在公司边工作边看机会；二是不签新合同拿钱离职后找新工作。我选择了后者，就是这样离职的。

职业规划呢是今年开始去到大厂提升技术视野、技术实力及其他软实力。本来想着边工作边看机会，但公司今年有这么个情况。就是公司今年被央企收购成为二级子公司，集团要求公司给全体员工签新合同工资写3k，绩效不写具体数，承诺工资总数不变，有一部分人包括我在内就没签，这个没签的人其实还挺多的，但公司也没办法他也不能强迫员工签，就一边是劳动法一边是集团，两头都没辙只能先签的就签了没签的就没签就只能先保持现状。恰好赶上我上一份合同到期，公司其实不想让我走，但是迫于集团的压力，肯定不能续签旧合同，就给了2个选择：要么签新合同，要么就公司给点钱直接不续了，这个时候呢就是离不离职主动权完全在我们这边了。当时考虑了几天，结合自己的职业规划，最终还是决定不签新合同，这样就从公司离职了。（正常不续签，劳动法公司不是得赔偿 n+1 嘛，当时公司就说给个 n，因为并不是公司不想续，公司也想跟大家续，但没办法，集团不让按老合同续，劳动法又必须按老合同续，这个就是也结合个人意愿，如果不想签就给个n就撤了，想签公司当然特别欢迎。）

### 职业规划

能去大厂去大厂，学习技术、拓展视野；用一到两年的时间学习大厂的研发模式积累经验。后续希望能有机会转管理带团队能做一个优秀的管理者，或走技术架构的路线。如果这期间遇到志同道的朋友有好的idea可以考虑创业（小概率，天时地利人和）。

### 这两个月在做什么

学习提升自己，也为后续面试作准备。准备一些算法、互联网行业的常见的技术架构、解决方案以及不同的方向未来要做哪些事等。

* 首选近几年流行且已经落地的，如：打车、直播；这些既比较前沿，又不会有落不了地的风险。
* 自动驾驶、AIGC（大模型）
* 传统互联网：电商、社交、游戏、搜广推

### 优点

工作踏实、认真负责；工作效率还可以不算低；学习能力也还可以，能解决问题；乐观、爱运动。靠谱；性格好，好相处，懂得换位思考。

### 缺点

* 在互联网大厂经验不足，但我会在进入公司后以最短时间来解决
* 性格温和，有时候即使是自己对的，但只要不违背原则，都不太会跟人去争执。
* 当局者迷，旁观者清，如果我知道缺点肯定早就去改正了

### 工作犯错怎么办

首先尽最大程度弥补和挽回损失，并和leader充分说明情况；事后总结经验教训，避免今后犯类似的错误

### 问hr问题

1. 公司有没有针对员工的培养路线、规划，我进去之后大概是怎样的。
2. 如何晋升、调薪
3. 福利待遇

## DMS

### 数据结构

group：8 服务器 * 4 块盘。（4个冗余），共 2 个 group。共 64T，可用 32 T 

set：同一 group 中不同服务器的同一盘序号，例如：[server1 node1, server2 node1,..., server7 node1, server8 node1] 构成一个 set。

冗余：2

这个 group 共有 4 个 set，每个文件存储在一个 set 中，每次分成 4 数据块，再计算 4 校验块。

### 性能测试

#### contentserver 性能测试

磁盘读写速率大概在 70M/s，带宽 = 1Gbps，即 125 MBps；读时瓶颈在网络，写时瓶颈在磁盘IO。

假设用户与服务器配置相同，以下为 1 个 group 测试结果：

| 并发用户数量 | 读(M/s) | 写(M/s) |
| ------------ | ------- | ------- |
| 1            | 100     | 70      |
| 10           | 10      | 6       |

#### coordinator 性能测试

Read

300～500 ops/s（mysql 约 1000 ops/s）。

### 坏盘/坏服务器

首先，坏一台服务器不会影响客户正常使用，客户读数据时可以从其余7台server再做逆运算（高斯消元）得到所有数据块；客户写数据时也是会写到其余7台server中，只不过少了一个冗余。

然后，会将坏server下线换上一台新server部署好程序后（**立即投入使用？Yes，优先保证性能正常使用，在空闲时恢复数据。在需要读坏块时，在此server进行计算返回顺便将此块恢复**），会在新server上进行group上所有文件都计算。对于坏server上的冗余块可以根据数据块正向计算可得，对于坏server上的数据块根据其他数据块和冗余块进行逆矩阵计算可得。（全空闲时恢复1T，写速率100M/s约需要**2.7h**）

### 读写文件完整性 -- HighwayHash

每块单独做校验和。相当于md5，只不过速率更快，将128bit结果存储在mysql中。

### 高可用

#### Contentserver 高可用（reed-solomon算法）

正向生成校验块：范德蒙矩阵 乘以 数据块组成的矩阵。

逆向根据校验块生成数据块：范德蒙逆矩阵 乘以 校验块及其与数据块得到数据块矩阵。

若数据块都在，则取数据块即可；否则，取数据块和冗余块进行计算后得到损坏数据块得到结果。

需先拿到所有块的流，进行矩阵运算，得到流式结果数据块。（计算在坏服务器端读取时计算）

#### RS 算法好处

* 可靠性更高，同样是1:1备份，原方案若两台server宕机则会丢失数据，采用RS算法最多允许任意4台服务器宕机数据还能恢复，5台才会丢数据；

* 不存在 1:1备份的一致性问题，系统更简单；

* 实际可用空间可配置大些，如 6 + 2；

* 运行中，可自动修复坏块；

* 维护简单，新服务器替换坏服务器即可，数据自动恢复；

* 扩展方便，直接加 group 即可（rebalance 算法）

  （**后期可考虑去掉 coordinator。才用 hash 确定 group，set 及路径，校验放到同路径下**。）

#### 架构演进

主备 --》reed-solomon

主备分为：同步写、异步写

同步写占用网络带宽，响应慢一些；

异步写（类mysql）存在延迟，并且存在数据丢失的可能，为了保证数据安全，采用了同步写。

#### Coordinator 高可用

##### 灾备

两台 coordinator，由于其无状态，不存储任何信息，所以完全可以由 ngnix 做平等转发。coor 与 cs 都定时向 mysql 发送心跳，coor 去查看心跳，发现有坏机器时向运维及研发发邮件。

##### 限流

guava

##### 降级

todo

### 扩容（rebalance）

每次扩容单位是 group，且每台服务器的盘数固定也是 4。如增加 8 * 4 或 16 * 4；

新增盘会从其他 set （记为 set1）中移动一些文件至新 set（记为 set2）。

1. 查看每个 set 的剩余可用容量，找到最小的，准备进行数据迁移。
2. 在该 set1 上选取 1G 的文件，如果文件都大于 1G，换一个 set。将数据复制到新 set2
3. 更新数据库中该文件的数据块的路径至新 set
4. 删除 set1 中该文件。

至 ABS（set2 剩余可用容量 - set1 剩余可用容量）< 10%，set2 置状态为可用。

#### 扩容时异常重启

### 上传

1. 请求 coor，插入数据库，获取锁；
2. 为文件找一个 set；（最大剩余容量、hash）
3. 在 coor 进行数据**分片**，例如，每个 set 有 8 块盘，配置冗余是 2，则将数据切分成 6 块，分别放到 6 块盘中，并且在客户端进行 reed-solomon 算法计算 2 冗余块内容，并分别上传至剩余 2 块盘。
4. coor 对该文件解锁。

### 下载

1. 请求 coor，获取数据所在 set 信息，如果所有服务器、磁盘都可用，就取所有数据块即可；若存在损坏块，就从数据库、校验块共 6 块，在客户端进行高斯消元求解损坏块。

### todo

- [ ] 列出上传下载速率指标，几台机器，多大文件，多块速率读写 
- [ ] minio高可用：erasure code，highway hash，reed-solomon code。n 份原始数据 + m 份备份数据，能通过 n+m 中的任意 n 份数据还原数据。
  - [ ] **范德蒙矩阵计算校验和**<img src="/Users/kyrie/Desktop/Screen Shot 2023-08-17 at 02.08.17.png" alt="Screen Shot 2023-08-17 at 02.08.17" style="zoom:40%;" />
  - [ ] **高斯消去法还原（行列式计算）**<img src="/Users/kyrie/Desktop/Screen Shot 2023-08-17 at 02.05.55.png" alt="Screen Shot 2023-08-17 at 02.05.55" style="zoom:40%;" />
  =======
  - [ ] 8 服务器 * 4 盘 = 8 * 4 * 4T = 128 T，实际容量 = 128T * 0.75 = 96T。
- [ ] minio高可用：erasure code，highway hash，reed-solomon code。n 份原始数据 + m 份备份数据，能通过 n+m 中的任意 n 份数据还原数据。todo 查论文。
  - [ ] **范德蒙矩阵计算校验和**<img src="https://github.com/zhangbotong/Interview/assets/7106986/962a253f-0bb4-43b6-a35d-72adf0e33cab)" alt="Screen Shot 2023-08-17 at 02.08.17" style="zoom:20%;" />

  - [ ] **高斯消去法还原（行列式计算）**<img alt="reed-solomon" src="https://github.com/zhangbotong/Interview/assets/7106986/7b0c02f0-3ee0-487b-91ca-60b2d0494174" style="zoom:20%;" />

>>>>>>> 3ba175aeb130c98460a5768e0c1d4daf3c66218c
  - [ ] 使用伽罗瓦场进行运算

java 矩阵运算包 ：**jama**(java matrix package)、jmathlib


### Why

* 高可用性，down 机
  * minio高可用：erasure code，highway hash，reed-solomon code。n 份原始数据 + m 份备份数据，能通过 n+m 中的任意 n 份数据还原数据。

* 单机性能瓶颈
* 扩容（动态添加 group）
* 容错性（同一组，各机器互为备份）
* 允许多台计算机共享和访问文件、

举例：HDFS，GFS(Google File System), Ceph

### What

文件存储、文件同步、文件下载

coor 是对等的，2台。

group 内剩余容量，以最小的机器为准，因此建议机器配置相同，以免浪费。

### 问题

* group 内增加机器，自动同步，同步完成后，系统自动将新增的服务器切换至线上提供服务。如何实现的
* 扩容，动态添加 group，如何实现的
* 一台机器down，如何自动切换，并提醒
* 如何处理并发访问
* 负载均衡，不同 group 剩余存储最大优先？
* 多个 coor 如何工作，挂了如何切换？
* coor、contentserver，可随时加入、退出，原理是什么？
* 上传失败，如何处理；重试 2 次后报错。
* 断点续传

### 遇到的印象深刻的问题并如何解决

1. mysql 死锁，原因：select for update；解决：业务逻辑绕过 select for update；总结：不允许使用 select for update。学习：将 mysql 的锁相关研究了个遍。
1. 扩容写热点问题 -- rebalance

### 考点

* 同一组内，上传完一台机器即为成功，后台线程同步至其他机器；写文件同时，写 binlog，只记录元数据，用于后台同步（？）。
* 如何处理并发访问？
  * 同一时间只有一个客户端能够修改文件：文件锁、乐观锁、分布式锁
  * coor 处理文件锁，一台 coor 会有单点故障问题，多台有同步问题？
* 如何处理网络中的丢包和超时？
  - 可以使用超时机制来检测丢包和超时情况，并根据具体情况进行重传或重新请求。此外，可以实现一些错误检测和纠正机制，如使用校验和或冗余数据等。
* 如何实现负载均衡和故障恢复？
  - 负载均衡可以通过在分布式文件系统中使用负载均衡算法，如轮询、随机选择或基于性能的选择来分发请求。故障恢复：**冗余存储**、故障转移策略。
* 数据传输协议？
  * HTTP？
* 如何确保分布式文件系统的安全性？
  * 可以采用多层次的安全措施，如身份验证、访问控制列表（ACL）、数据加密和安全传输协议（如TLS/SSL）。另外，定期进行安全审计和漏洞扫描也是保障系统安全的重要措施。

### Key

* 不同的块可以被存储在不同的存储节点上，以实现数据的并行读写和负载均衡

### HighwayHash

利用现代计算机的 SIMD（Single Instruction, Multiple Data）架构，利用计算机硬件的并行性和数据并行性，通过同时处理多个数据块来加速哈希计算。

md5(message digest algorithm 5, 128-bit)：弱hash

SHA-256(secure hash algorithm 256-bit)：强hash

源码：利用一些与或非异或操作和移位操作，将每4字节（传入的key: a0,a1,a2,a3）与固定的4字节进行逻辑操作得到hash值。

底层使用 SIMD 指令，一次操作多个数据，加快速度。

### SIMD

Single Instruction Multi Data 一条指令处理多条数据。有点像向量（矩阵）运算。

![img](http://ftp.cvut.cz/kernel/people/geoff/cell/ps3-linux-docs/CellProgrammingTutorial/CellProgrammingTutorial.files/image008.jpg)

### 分布式知识点

#### 选主算法

如果每个节点都可以写数据，这样容易造成数据的不一致，所以需要选举一个leader，往leader节点中写数据，然后同步到follower节点中。这样就能更好的保证一致性。

##### Raft算法

##### Bully 算法

![img](https://static001.geekbang.org/resource/image/fc/b8/fc0f00a3b7c9290bc91cb4d8721dc6b8.png?wh=571*378)

##### ZAB(zookeeper atomic broadcast) 算法

#### 分布式事务

2PC（2 Phase Commit），eg. mysql 

#### 分布式锁

##### 基于数据库

##### 基于内存

### 可靠性（Reed-solomon codes）

SEC-DED(Single Error Correcting - Double Error Detect)

### 思考

**去mysql化**

写：文件全路径做hash，映射到不同的 set 及路径，写入这些块。

读：文件全路径做hash，得到文件块的server及路径，获取所有块，进行矩阵逆运算。

### 参考文献

reed-solomon论文：chrome-extension://cdonnmffkdaoajfknoeeecmchibpmkmg/assets/pdf/web/viewer.html?file=https%3A%2F%2Fcgi.di.uoa.gr%2F~ad%2FM155%2FPapers%2FRS-Tutorial.pdf

## 业财

六七千合同、几百亿流水（每年约一百多亿）、3w左右张发票（老合同都放在一张票）

平均每天一两个合同，四五张发票

### 业务梳理

#### 收款线

合同拆分、完工确认、发票、到款

#### 付款线

合同预算、内部协作、收入分配、采购

#### 公司内不同组对接（mq（合同、项目））

合同管理、项目管理（mq）（公司内一般直接查别的组的 redis，不会先通过接口查再放到自己的 redis）

#### 外部系统对接（sap）

通过接口推送（放到 redis）

### 技术

台账统计：合理建立索引、晚上做统计到天的计算、晚上做系统内的一致性计算

mq：合同、项目等公司内不同组间数据传输

redis：请求基础数据时通过接口，放到redis缓存；分布式锁（解决例如拆分时连续点击两次提交）

